# Logging Ethereum Applications Based on Transaction Traces

This project can be used to log execution data of decentralized applications (DApps) deployed to Ethereum.
The execution data is generated by recomputing transaction traces -- the computational steps to process an Ethereum transaction.
On a high level, the code implements the following functionality for a user-defined blockrange: 

1. Extraction: Recursively re-create transaction traces for contract addresses and discover addresses belonging to a DApp by following CREATE-relations from contract deployments in the transaction trace data.
3. Decode: Decode the blockchain log entry, CALL, and DELEGATECALL input data in the transaction traces based on contract ABIs.
4. Transform: Example code to transform the decoded trace data to an event log for object-centric process mining (OCEL 2.0) in [log_construction](src/trace_based_logging/log_construction).  

There are prerequisites for running the program: 
- Etherscan API Key. The transaction retrieval is in part based on querying normal transactions and internal transactions from Etherscan.  
- Ethereum Archive Node with a Geth-based client (e.g., Geth or Erigon).
  - Transaction retrieval by events (Ethereum log entries) uses the Python web3 library function ```eth.get_logs``` https://web3py.readthedocs.io/en/stable/web3.eth.html#web3.eth.Eth.get_logs 
  - The program recreates transaction traces based on the Geth debug function ```debug_traceTransaction``` https://geth.ethereum.org/docs/interacting-with-geth/rpc/ns-debug#debug_traceTransaction


## Installation

1. Clone the repository:
```console
git clone [this project]
```

2. Install the required dependencies:
```console
pip install -r requirements.txt
```


## Configuration

Before running the main script, configure the json files in the project folder. 

[config.json](config.json), a file with basic parameters:

- Ethereum Node Configuration (`ethereum_node`):
  - **`protocol`**: Protocol used for connection (`http://` by default).
  - **`host`**: IP address of the Ethereum archive node (`127.0.0.1` by default).
  - **`port`**: Port to connect to the Ethereum archive node (`8081` by default).

- Contracts (`contracts`):
  - **`dapp`**: List containing contract addresses that belong to the DApp.
  - **`non_dapp`**: List containing contract addresses explicitly excluded from the DApp.

- Block Range (`block_range`):
  - **`min_block`**: Minimum Ethereum block number for data extraction.
  - **`max_block`**: Maximum Ethereum block number for data extraction.

- Data Extraction (`extraction`):
  - **`normal_transactions`**: `true` to extract normal transactions from Etherscan.
  - **`internal_transactions`**: `true` to extract internal transactions from Etherscan.
  - **`transactions_by_events`**: `true` to extract transactions based on emitted blockchain events from the Ethereum node.
  - **`etherscan_api_key`**: API key for Etherscan, required to fetch data from Etherscan (ABIs, normal transactions, internal transactions).

- Output Settings (`output`):

  - DApp-related (`dapp`):
    - **`events`**: Include events emitted by DApp contracts (`true`/`false`).
    - **`calls`**: Include calls involving Ether transfers to DApp contracts (`true`/`false`).
    - **`delegatecalls`**: Include delegatecalls to DApp contracts (`true`/`false`).
    - **`zero_value_calls`**: Include calls without Ether transfers to DApp contracts (`true`/`false`).
    - **`creations`**: Include creations of DApp contracts (`true`/`false`).

  - Non-DApp-related (`non_dapp`):
    - **`events`**: Include events emitted by non-DApp contracts (`true`/`false`).
    - **`calls`**: Include calls involving Ether transfers to non-DApp contracts (`true`/`false`).
    - **`delegatecalls`**: Include delegatecalls to non-DApp contracts (`true`/`false`).
    - **`zero_value_calls`**: Include calls without Ether transfers to non-DApp contracts (`true`/`false`).
    - **`creations`**: Include creations of non-DApp contracts (`true`/`false`).

- Processing Stages (`stages`):
  - **`extraction`**: Enable or disable extraction stage (`true`/`false`).
  - **`decoding`**: Enable or disable decoding stage (`true`/`false`).
  - **`transformation`**: Enable or disable transformation stage (`true`/`false`).

- Miscellaneous (`misc`):
  - **`sensitive_events`**: Enable or disable for creating events with context information (e.g., by role of the involved contract; `true`/`false`).
  - **`log_folder`**: Folder path to store output logs (`output` by default).


[config_custom_events.json](src/trace_based_logging/trace_decoder/config_custom_events.json), a file with ABI specifications for decoding the data. If the ABI of a contract is not available (on Etherscan), a contract's events or functions can be decoded with fall-back specifications. By default this includes ABI specifications to decode the events from the standards ERC-20, ERC-721, ERC-777, and ERC-1155 (and two custom Augur events).

[mappings.json](src/trace_based_logging/log_construction/mappings.json), a file with mappings for data transformation (e.g., semantics and context information).

## Usage

To execute the main function of the project, run:
```console
python src/trace_based_logging/__main__.py
```

The output files are saved to [resources](resources), and therein to the output folder specified in the `config.json`. The output is structured by the stage it was created in:

- **`Extraction`**:
  - Tabular transaction trace data
  - List of contracts identified as belonging to the DApp

- **`Decoding`**
  - Tabular data of creations identified in the trace data
  - Dictionary of ABIs available for the identified contracts
  - Tabular data of events, calls, zero-value calls, and delegate calls. Divided in DApp and non-DApp. Decoded where possible. 

- **`Transformation`**
  - Tabular contextualized and formatted data of events, calls, zero-value calls, and delegate calls. Divided in DApp and non-DApp.
  - Tabular data with OCEL events, objects, and event-to-object relations
  - OCEL 2.0 event log

## Related publications

Hobeck, R., Berti, A., Weber, I., & van der Aalst, W. M. P. (2025). Object-centric process mining for blockchain applications: Extracting and representing Ethereum execution data in OCEL 2.0. Enterprise Modelling and Information Systems Architectures.

## Remarks

Please note that docstrings in this repository were drafted by ChatGPT and edited by the author.


## License

This project is distributed under the [MIT license](LICENSE).